<div class="d-none d-lg-block">
  <table class='table table-hover table-inverse posts-index-table'>
    <thead>
      <tr>
        <th></th>
        <th>タイトル</th>
        <th><%= sort_link_for_posts('公開年', 'release') %></th>
        <th><%= sort_link_for_posts('時系列', 'timeline') %></th>
        <th>タグ</th>
        <th>コメント数</th>
        <th>いいね</th>
        <th>投稿者</th>
        <th>評価</th>
        <th>投稿指数</th>
        <th>投稿日時</th>
      </tr>
    </thead>
    <tbody>
      <% posts.each do |post| %>
        <tr>
          <td><%= image_tag post.get_image(70, 70) %>
          </td>
          <td><%= link_to post.title,post, class: "post_#{post.id}" %></td>
          <td><%= post.release %></td>
          <td><%= post.timeline %></td>
          <td>
            <% if post.tag.present? %>
              <%= link_to post.tag, search_path(model: 'post_tag', method: 'partial', content: post.tag) %>
            <% end %>
          </td>
          <td><%= post.comments.count %></td>
          <td>
            <div id="post_<%= post.id %>">
              <%= render "public/favorites/btn", post: post %>
            </div>
          </td>
          <td><%= link_to post.user.name,post.user, class: "user_#{post.user.id}" %></td>
          <td>
            <div id="raty_<%= post.id %>"></div>
          </td>
          <td>
            <!--%= post.score %-->
            <%= post.sentiment_emoji %>
          </td>
          <td>
            <%= post.formatted_created_at %>
          </td>
        </tr>
      <% end %>
    </tbody>

    <span id="back">
      <a href="#">
        <%= image_tag "arrow.png", alt: "トップへ戻る" %>
      </a>
    </span>

  </table>
</div>

<div class="d-block d-lg-none">
  <% posts.each do |post| %>
    <div class="mb-3 pb-3 border-bottom border-secondary">
      <!-- タイトル -->
      <div class="p-2 d-flex gap-2 align-items-start">
        <div class="flex-shrink-0">
          <%= image_tag post.get_image(60, 60) %>
        </div>
        <div class="flex-grow-1">
          <%= link_to post.title, post, class: "fw-bold text-decoration-none d-block" %>
        </div>
      </div>

      <!-- 2列×2段（公開/タグ、投稿者/時系列） -->
      <div class="row g-0 border-top">
        <div class="col-6 p-2 border-end">
          公開：<%= post.release %>年
        </div>
        <div class="col-6 p-2">
          タグ：
          <% if post.tag.present? %>
            <%= link_to post.tag, search_path(model: 'post_tag', method: 'partial', content: post.tag) %>
          <% end %>
        </div>

        <div class="col-6 p-2 border-top border-end">
          投稿者：<%= link_to post.user.name, post.user, class: "text-decoration-none" %>
        </div>
        <div class="col-6 p-2 border-top border-end">
          時系列：<%= post.timeline %>
        </div>

        <div class="col-6 p-2 border-top border-end">
          コメント数：<%= post.comments.count %>
        </div>
        <div class="col-6 p-2 border-top border-end">
          投稿日時：<%= post.formatted_created_at %>
        </div>

      </div>

    </div>
  <% end %>
</div>

<script>
  $(document).on('turbolinks:load', function() {
    <% posts.each do |post| %>
      (function() {
        var elem = document.querySelector('#raty_<%= post.id %>');
        if (!elem) return;

        elem.innerHTML = "";
        var opt = {
          starOn: "<%= asset_path('star-on.png') %>",
          starOff: "<%= asset_path('star-off.png') %>",
          starHalf: "<%= asset_path('star-half.png') %>",
          score: <%= post.rate.present? ? post.rate : 'undefined' %>,
          readOnly: true
        };
        raty(elem, opt);
      })();
    <% end %>

    $('#back a').on('click', function(event) {
      $('body, html').animate({ scrollTop: 0 }, 800);
      event.preventDefault();
    });
  });
</script>